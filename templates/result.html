<!DOCTYPE html>
<html lang="en">
<head>
    {% set static_version = '20240519' %}
    {% include '_partials/head_assets.html' %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="RegCheck is an AI tool to compare preregistrations with papers instantly."/>
    <meta name="robots" content="noindex,nofollow">
    <meta name="author" content="Jamie Cummins">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RegCheck Results</title>
    <style>
        .results-page .results-table__cell--prereg,
        .results-page .results-table__cell--paper,
        .results-page .results-table__cell--notes {
            font-size: 0.82rem;
            line-height: 1.45;
        }

        /*
         * Note: overflow on <td> is inconsistently supported across browsers.
         * Wrap long content in a block-level div and scroll that instead.
         */
        .results-table__scroll {
            max-height: 11rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .results-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            width: 100%;
        }

        .results-toggle-select {
            width: auto;
            min-width: 10.5rem;
            background: #0c0f1a;
            color: #f5f7ff;
            border: 1px solid #2a3148;
            border-radius: 10px;
            font-size: 0.82rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            letter-spacing: 0.03em;
            padding: 0.35rem 1.6rem 0.35rem 0.75rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23f5f7ff' d='M1.41 0 6 4.58 10.59 0 12 1.41 6 7.41 0 1.41z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.55rem center;
            background-size: 0.6rem;
            cursor: pointer;
            box-shadow: none;
            transition: border-color 0.15s ease, color 0.15s ease, background-color 0.15s ease;
        }

        .content-variant {
            display: none;
        }

        .content-variant.active {
            display: block;
        }

        .results-toggle-select:focus {
            outline: none;
            border-bottom-color: rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .results-toggle-select:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.04);
        }

        .results-page .cover-container {
            padding-top: 1rem !important; /* match Bootstrap p-3 top padding used sitewide */
        }

        .results-page #results-page-tagline {
            margin: 0;
            letter-spacing: 0.04em;
            padding: 0;
        }

        .results-page .results-main {
            margin-top: 0.3rem;
        }

        .results-page header.mb-auto {
            margin-bottom: 0 !important;
        }

        .results-page .results-meta {
            margin: 0.25rem auto 0.5rem;
            max-width: 100%;
            min-width: 0;
            width: 100%;
        }

        .results-page .results-log {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            margin: 0 auto;
            text-align: center;
        }

        .results-page .workflow-log-inline {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            flex-wrap: nowrap;
        }

        .results-page .workflow-log-header {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .results-page #workflow-log-line {
            word-break: break-word;
            text-align: center;
            max-width: 720px;
            margin: 0 auto;
        }

        .results-page #workflow-log-container {
            margin-top: 0;
        }

        .results-page #processing-status-note {
            margin-bottom: 0.15rem;
        }

        @media (max-width: 768px) {
            .results-page .results-meta {
                max-width: 100%;
                min-width: 0;
            }

            .results-page .results-log {
                align-items: flex-start;
                text-align: left;
                max-width: 100%;
            }

        }
    </style>
</head>
<body class="d-flex h-100 text-center text-bg-dark results-page page-shell">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto">
            {% include '_partials/navbar.html' %}
        </header>

        <main class="px-3 results-main">
            <h1 class="text-center" id="results-page-tagline">Your RegCheck Report</h1>
                <div class="results-meta d-flex justify-content-center">
                    <div class="results-log text-center">
                        <div class="workflow-log-inline">
                            <div class="workflow-log-header">
                                <p class="small text-uppercase fw-semibold mb-0">Workflow log</p>
                                <div id="workflow-spinner" class="spinner-border spinner-border-sm text-info" role="status" aria-hidden="true"></div>
                            </div>
                            <p id="workflow-log-line" class="small mb-0 font-monospace text-info"></p>
                        </div>
                        <p id="processing-status-note" class="small mb-0"></p>
                    </div>
                </div>
            <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <label for="quote-limit-select" class="small mb-0">Quotes shown per cell:</label>
                    <select id="quote-limit-select" class="form-select form-select-sm" style="width: auto; min-width: 6rem; font-size: 0.8rem;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="all">All available</option>
                    </select>
                </div>
                <!-- Legend explaining row colors -->
                <div class="results-legend mb-0" aria-label="Legend: row color meanings">
                    <span class="legend-item"><span class="legend-swatch legend-swatch--red"></span> Deviation found</span>
                    <span class="legend-item"><span class="legend-swatch legend-swatch--blue"></span> No deviation</span>
                    <span class="legend-item"><span class="legend-swatch legend-swatch--amber"></span> Missing information / No information found</span>
                </div>
            </div>

            <!-- Result container, will be dynamically updated -->
            <div id="result-container" class="table-responsive results-table-wrapper">
                <table id="results-table" class="results-table align-middle">
                    <thead>
                        <tr>
                            <th>Dimension</th>
                            <th>
                                <div class="results-toggle">
                                    <select id="prereg-view-toggle" class="form-select form-select-sm results-toggle-select" aria-label="Preregistration view">
                                        <option value="quotes" selected>PREREGISTRATION — DIRECT QUOTES</option>
                                        <option value="summary">PREREGISTRATION — SUMMARY</option>
                                    </select>
                                </div>
                            </th>
                            <th>
                                <div class="results-toggle">
                                    <select id="paper-view-toggle" class="form-select form-select-sm results-toggle-select" aria-label="Paper view">
                                        <option value="quotes" selected>PAPER — DIRECT QUOTES</option>
                                        <option value="summary">PAPER — SUMMARY</option>
                                    </select>
                                </div>
                            </th>
                            <th>Deviation Information</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-submit" id="app-download-btn">Download as CSV</button>
            </div>
        </main>

        <footer class="mt-auto text-white-50 custom-footer-padding">
            <p>Jamie Cummins & Malte Elson, <a class="footer-link" target="_blank" href="https://www.dig.psy.unibe.ch/index_eng.html">Psychology of Digitalisation</a>, University of Bern, 2025</p>
        </footer>
    </div>

    <script src="{{ url_for('static', path='js/bootstrap.bundle.min.js') }}?v={{ static_version }}"></script>
    <script>
        document.getElementById('app-download-btn').addEventListener('click', function() {
            var csv = [];
            var rows = document.querySelectorAll('.table-responsive table tr');

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll('td, th');

                for (var j = 0; j < cols.length; j++) {
                    var cell = cols[j];
                    if (cell.matches('td')) {
                        row.push(getCellCsvText(cell)); // use active variant text for dropdown columns
                    } else if (cell.matches('th')) {
                        var select = cell.querySelector('select');
                        if (select) {
                            var labelEl = cell.querySelector('.results-column-title');
                            var labelText = labelEl ? labelEl.innerText : "";
                            var selectedText = select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : '';
                            var headerValue = labelText
                                ? (labelText + ' (' + selectedText + ')').trim().replace(/,/g, '')
                                : (selectedText || '').replace(/,/g, '');
                            row.push(headerValue);
                        } else {
                            row.push(cell.innerText.replace(/,/g, ''));
                        }
                    } else {
                        row.push(cell.innerText.replace(/,/g, ''));
                    }
                }

                csv.push(row.join(","));
            }

            // Download CSV
            var csvFile = new Blob([csv.join("\n")], { type: 'text/csv' });
            var downloadLink = document.createElement('a');
            downloadLink.download = 'output.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';

            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });
    </script>
    <script>
        (function() {
        })();
    </script>
<script>
    function createResultsCell(content, extraClass = "") {
        const cell = document.createElement("td");
        cell.className = `results-table__cell ${extraClass}`.trim();

        // For long text columns, wrap content in a scrollable div
        const needsScroll = extraClass.includes("results-table__cell--prereg")
            || extraClass.includes("results-table__cell--paper")
            || extraClass.includes("results-table__cell--notes");

        if (needsScroll) {
            const wrapper = document.createElement("div");
            wrapper.className = "results-table__scroll";
            wrapper.innerHTML = content || "";
            cell.appendChild(wrapper);
        } else {
            cell.innerHTML = content || "";
        }
        return cell;
    }

    function applyVariantToCell(cell, variant) {
        const variants = cell.querySelectorAll(".content-variant");
        variants.forEach((el) => el.classList.remove("active"));
        const target = cell.querySelector(`.content-variant--${variant}`);
        if (target) {
            target.classList.add("active");
        } else if (variants.length > 0) {
            variants[0].classList.add("active");
        }
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function parseQuotes(quotes) {
        if (!quotes) return [];
        const parts = [];
        const regex = /\[((?:PREREG|PAPER)_(\d+)),\s*relevance_score=([0-9.]+)\]\s*([\s\S]*?)(?=(\[(?:PREREG|PAPER)_[0-9]{4,}[^\]]*\])|$)/g;
        let match;
        while ((match = regex.exec(quotes)) !== null) {
            const chunk = (match[0] || "").trim();
            if (!chunk) continue;
            const id = match[1] || "";
            const num = parseInt(match[2], 10);
            const score = parseFloat(match[3]);
            const text = (match[4] || "").trim();
            parts.push({
                id,
                num: Number.isFinite(num) ? num : 0,
                score: Number.isFinite(score) ? score : 0,
                text,
                raw: chunk,
            });
        }
        if (parts.length === 0) {
            // Fallback: treat blank lines as separators
            const fallback = quotes.split(/\n\s*\n/);
            return fallback
                .map(p => p.trim())
                .filter(Boolean)
                .map((t, idx) => ({
                    id: `QUOTE_${idx + 1}`,
                    num: idx + 1,
                    score: 0,
                    text: t,
                    raw: t,
                }));
        }
        return parts;
    }

    function renderQuotes(quotesList, limit) {
        if (!Array.isArray(quotesList) || quotesList.length === 0) return "";

        // Sort by relevance (score desc) to select, then by doc order (id num asc) to display
        let sorted = [...quotesList].sort((a, b) => (b.score || 0) - (a.score || 0));
        if (typeof limit === "number" && limit > 0) {
            sorted = sorted.slice(0, limit);
        }
        sorted.sort((a, b) => (a.num || 0) - (b.num || 0));

        return sorted
            .map(q => {
                let label = "";
                if (q.id) {
                    const scoreStr =
                        Number.isFinite(q.score) && q.score !== null
                            ? `, relevance_score=${q.score.toFixed(3)}`
                            : "";
                    label = `[${escapeHtml(q.id)}${scoreStr}] `;
                }
                return label + escapeHtml(q.text || q.raw || "");
            })
            .join("<br><br>");
    }

    function applyQuoteLimitAll() {
        const limit = window.quoteLimit;
        document.querySelectorAll(".content-variant--quotes").forEach(div => {
            const quotesList = div._quotesList || [];
            div.innerHTML = renderQuotes(quotesList, limit);
        });
    }

    function createToggleCell({ quotes, summary, section }) {
        const cell = document.createElement("td");
        const sectionClass = section === "paper" ? "results-table__cell--paper" : "results-table__cell--prereg";
        cell.className = `results-table__cell ${sectionClass}`.trim();
        cell.dataset.section = section;

        const wrapper = document.createElement("div");
        wrapper.className = "results-table__scroll";

        const quotesDiv = document.createElement("div");
        quotesDiv.className = "content-variant content-variant--quotes";
        const quotesList = parseQuotes(quotes);
        quotesDiv._quotesList = quotesList;
        quotesDiv.innerHTML = renderQuotes(quotesList, window.quoteLimit);

        const summaryDiv = document.createElement("div");
        summaryDiv.className = "content-variant content-variant--summary";
        summaryDiv.innerHTML = summary || "";

        wrapper.appendChild(quotesDiv);
        wrapper.appendChild(summaryDiv);
        cell.appendChild(wrapper);

        const view = section === "paper" ? window.paperView || "quotes" : window.preregView || "quotes";
        applyVariantToCell(cell, view);
        return cell;
    }

    function updateSectionView(section, variant) {
        const cells = document.querySelectorAll(`td[data-section="${section}"]`);
        cells.forEach((cell) => applyVariantToCell(cell, variant));
    }

    function getCellCsvText(cell) {
        const activeVariant = cell.querySelector(".content-variant.active");
        if (activeVariant) {
            return activeVariant.innerText.replace(/,/g, "");
        }
        return (cell.innerText || "").replace(/,/g, "");
    }

    window.preregView = "quotes";
    window.paperView = "quotes";
    window.quoteLimit = 3;

    const preregToggle = document.getElementById("prereg-view-toggle");
    const paperToggle = document.getElementById("paper-view-toggle");

    if (preregToggle) {
        preregToggle.addEventListener("change", (event) => {
            window.preregView = event.target.value || "quotes";
            updateSectionView("prereg", window.preregView);
        });
    }

    if (paperToggle) {
        paperToggle.addEventListener("change", (event) => {
            window.paperView = event.target.value || "quotes";
            updateSectionView("paper", window.paperView);
        });
    }

    const quoteLimitSelect = document.getElementById("quote-limit-select");
    if (quoteLimitSelect) {
        quoteLimitSelect.addEventListener("change", (event) => {
            const value = event.target.value;
            if (value === "all") {
                window.quoteLimit = undefined;
            } else {
                const parsed = parseInt(value, 10);
                window.quoteLimit = Number.isFinite(parsed) && parsed > 0 ? parsed : 3;
            }
            applyQuoteLimitAll();
        });
    }

    function getDeviationRowClass(deviation) {
        const normalized = (deviation || "").toString().trim().toLowerCase();
        if (normalized === "yes") return "results-table__row--dev-yes";
        if (normalized === "no") return "results-table__row--dev-no";
        // Prepare for potential future states like missing/unknown
        if (normalized === "unknown" || normalized === "missing" || normalized === "no information found" || normalized === "information missing") {
            return "results-table__row--dev-unknown";
        }
        return "";
    }

    let lastWorkflowStatus = null;
    window.latestWorkflowStatus = "";
    const workflowSpinner = document.getElementById("workflow-spinner");

    function appendWorkflowLog(statusText) {
        if (!statusText) return;
        if (statusText === lastWorkflowStatus) return;
        lastWorkflowStatus = statusText;
        window.latestWorkflowStatus = statusText;
        const logLine = document.getElementById("workflow-log-line");
        if (!logLine) return;
        const timestamp = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        logLine.textContent = `[${timestamp}] ${statusText}`;
    }

    async function pollTaskStatus() {
        const taskId = "{{ task_id }}";
        const resultContainer = document.getElementById("result-container");
        const loadingMessage = document.getElementById("loading-message");
        const processedCounter = document.getElementById("processed-count");
        const totalCounter = document.getElementById("total-count");
        const statusNote = document.getElementById("processing-status-note");

        const coerceCount = (value) => {
            if (value === null || value === undefined) {
                return null;
            }
            if (typeof value === "number" && Number.isFinite(value)) {
                return value;
            }
            if (typeof value === "string") {
                const parsed = Number.parseInt(value.trim(), 10);
                if (!Number.isNaN(parsed)) {
                    return parsed;
                }
            }
            return null;
        };

        function updateProgress(processed, total, state) {
            if (processedCounter && processed !== null) {
                processedCounter.textContent = processed;
            }
            if (totalCounter && total !== null) {
                totalCounter.textContent = total;
            }
            if (statusNote) {
                statusNote.classList.remove("text-danger", "text-success", "text-muted");
                if (state === "SUCCESS") {
                    statusNote.textContent = "";
                    statusNote.classList.add("text-success");
                } else if (state === "FAILURE") {
                    statusNote.textContent = window.latestWorkflowStatus || "An error occurred while processing your request.";
                    statusNote.classList.add("text-danger");
                } else {
                    statusNote.textContent = "";
                    statusNote.classList.add("text-muted");
                }
            }
            if (loadingMessage) {
                loadingMessage.dataset.state = state || "PENDING";
            }

            if (workflowSpinner) {
                if (state === "SUCCESS" || state === "FAILURE") {
                    workflowSpinner.classList.add("d-none");
                    workflowSpinner.setAttribute("aria-hidden", "true");
                } else {
                    workflowSpinner.classList.remove("d-none");
                    workflowSpinner.removeAttribute("aria-hidden");
                }
            }

            const logLine = document.getElementById("workflow-log-line");
            if (logLine) {
                logLine.className = "small mb-0 font-monospace";
                if (state === "SUCCESS") {
                    logLine.classList.add("text-success");
                } else {
                    logLine.classList.add("text-info");
                }
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch(`/task_status/${taskId}`);
                const data = await response.json();
                appendWorkflowLog(data.status || data.state || "");

                let processedCount = coerceCount(data.processed_dimensions);
                let totalCount = coerceCount(data.total_dimensions);

                if (data.result && Array.isArray(data.result.items)) {
                    const resultsTableBody = document.querySelector("#results-table tbody");
                    const existingKeys = new Set();
                    if (resultsTableBody) {
                        for (const row of resultsTableBody.querySelectorAll("tr")) {
                            const key = row.getAttribute("data-key");
                            if (key) {
                                existingKeys.add(key);
                            }
                        }
                    }
                    const uniqueDimensions = new Set();
                    data.result.items.forEach(item => {
                        const rawDimension = item && typeof item.dimension === "string" ? item.dimension : "";
                        const key = `${rawDimension}`;
                        uniqueDimensions.add(key);
                        if (!existingKeys.has(key)) {
                            const tr = document.createElement("tr");
                            tr.setAttribute("data-key", key);
                            tr.classList.add("results-table__row");
                            const rowClass = getDeviationRowClass(item.deviation_judgement);
                            if (rowClass) tr.classList.add(rowClass);

                            const dimensionCell = createResultsCell(item.dimension || "", "results-table__cell--dimension");
                            const preregCell = createToggleCell({
                                quotes: item.registration_content_quotes || "",
                                summary: item.registration_content_summary || "",
                                section: "prereg"
                            });
                            const paperCell = createToggleCell({
                                quotes: item.paper_content_quotes || "",
                                summary: item.paper_content_summary || "",
                                section: "paper"
                            });
                            const notesCell = createResultsCell(item.deviation_information || "", "results-table__cell--notes");

                            tr.appendChild(dimensionCell);
                            tr.appendChild(preregCell);
                            tr.appendChild(paperCell);
                            tr.appendChild(notesCell);

                            if (resultsTableBody) {
                                resultsTableBody.appendChild(tr);
                                existingKeys.add(key);
                            }
                        }
                    });
                    if (processedCount === null) {
                        processedCount = uniqueDimensions.size;
                    }
                    if (totalCount === null && uniqueDimensions.size > 0) {
                        totalCount = uniqueDimensions.size;
                    }
                }

                if (processedCount === null && processedCounter) {
                    const existingProcessed = coerceCount(processedCounter.textContent);
                    if (existingProcessed !== null) {
                        processedCount = existingProcessed;
                    } else {
                        processedCount = 0;
                    }
                }
                if (totalCount === null && totalCounter) {
                    const existingTotal = coerceCount(totalCounter.textContent);
                    if (existingTotal !== null) {
                        totalCount = existingTotal;
                    } else if (processedCount !== null) {
                        totalCount = processedCount;
                    }
                }

                updateProgress(processedCount, totalCount, data.state);

                if (data.state === "FAILURE") {
                    resultContainer.innerHTML = "<p class='text-danger'>An error occurred while processing your request.</p>";
                    return;
                }

                if (data.state !== "SUCCESS") {
                    setTimeout(checkStatus, 3000);
                }
            } catch (e) {
                resultContainer.innerHTML = "<p class='text-danger'>Failed to fetch status. Please refresh the page.</p>";
                updateProgress(null, null, "FAILURE");
            }
        }
        checkStatus();
    }
    window.onload = pollTaskStatus;
</script>
</body>
</html>
